dependsOn:
  - frontend

fileGroups:
  outputs:
    - "dist/**/*"

tasks:
  build:
    command:
      - "vendor/bin/box"
      - "compile"
    deps:
      - format
      - lint
      - test
      - ^:build
    inputs:
      - "@group(phpSources)"
      - "box.json"
    outputs:
      - "@group(outputs)"

  preview:
    command: composer preview

  trap:
    command: composer trap

  # This task runs tests on a specific PHP version using Docker
  test-php-compatibility:
    command:
      - "docker"
      - "compose"
      - "up"
      - "--build"
    inputs:
      - "@group(phpSources)"
      - "@group(phpTests)"
      - "docker-compose.yaml"
      - "docker/*"

  # Extracts built PHAR to a test directory
  extract-phar:
    script: "rm -rf _phar/* && phar extract -f dist/Nanomanager.phar _phar"
    outputs:
      - "_phar/**/*"
    deps:
      - build
